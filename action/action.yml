name: Package lock diff
description: Show package lock diff in comment using beefdiff

inputs:
  work-dir:
    description: 'Directory to run the diff in'
    required: false
    default: ''
  node_version:
    description: 'Node version to setup. Can set to blank string to disable node setup'
    required: false
    default: '24'
  filename:
    description: 'Lockfile filename to diff (e.g., package-lock.json, yarn.lock, pnpm-lock.yaml)'
    required: false
    default: 'package-lock.json'
  resolver:
    description: 'Resolver to use (npm, yarn, pnpm, composer, python, ruby)'
    required: false
    default: 'npm'
  format:
    description: 'Output format (text, html, markdown)'
    required: false
    default: 'markdown'
  github_token:
    description: 'GitHub token for API calls (defaults to github.token if not provided)'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      if: ${{ inputs.node_version != '' }}
      with:
        node-version: ${{ inputs.node_version }}

    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install beefdiff
      shell: bash
      run: npm install -g @tractorcow/beefdiff

    - name: Prepare package lock diff
      shell: bash
      run: |
        OLD_FILE="lockfile.old"
        NEW_FILE="${{ inputs.filename }}"
        OLD_FILE_PATH=""
        NEW_FILE_PATH=""

        # Determine file paths
        if [ -z "${{ inputs.work-dir }}" ]; then
          OLD_FILE_PATH="${{ inputs.filename }}"
          NEW_FILE_PATH="${{ inputs.filename }}"
        else
          OLD_FILE_PATH="${{ inputs.work-dir }}/${{ inputs.filename }}"
          NEW_FILE_PATH="${{ inputs.work-dir }}/${{ inputs.filename }}"
        fi

        # Extract old file from base branch if it exists
        if git show ${{ github.event.pull_request.base.sha }}:"$OLD_FILE_PATH" > "$OLD_FILE" 2>/dev/null; then
          OLD_EXISTS=true
        else
          OLD_EXISTS=false
          rm -f "$OLD_FILE"
        fi

        # Check if new file exists
        if [ -f "$NEW_FILE_PATH" ]; then
          NEW_EXISTS=true
        else
          NEW_EXISTS=false
        fi

        # Generate diff only if both files exist
        if [ "$OLD_EXISTS" = true ] && [ "$NEW_EXISTS" = true ]; then
          beefdiff "$OLD_FILE" "$NEW_FILE_PATH" --resolver=${{ inputs.resolver }} --format=${{ inputs.format }} > package_diff_raw.md 2>/dev/null || true
        else
          # Skip diff if either file is missing
          touch package_diff_raw.md
        fi

        # Create final diff file if we have content
        if [[ -s package_diff_raw.md ]]; then
          echo "<!-- beefdiff-package-lock-diff -->" > package_diff.md
          echo "# Package lock diff" >> package_diff.md
          echo "" >> package_diff.md
          cat package_diff_raw.md >> package_diff.md
        fi

    - name: Find existing comment
      if: always() && hashFiles('package_diff.md') != ''
      id: find-comment
      uses: peter-evans/find-comment@v2
      with:
        token: ${{ inputs.github_token != '' && inputs.github_token || github.token }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: '<!-- beefdiff-package-lock-diff -->'

    - name: Create or update PR comment
      if: always() && hashFiles('package_diff.md') != ''
      uses: peter-evans/create-or-update-comment@v5
      with:
        token: ${{ inputs.github_token != '' && inputs.github_token || github.token }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        edit-mode: replace
        body-path: package_diff.md
